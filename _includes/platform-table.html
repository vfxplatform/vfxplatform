{% comment %}
  Platform table include
  Usage: {% include platform-table.html years=supported_years show_history_link=true %}
{% endcomment %}

{% assign col_count = include.years | size | plus: 1 %}

<div class="platform-table-wrapper">
  <div class="overflow-x-auto">
    <table class="platform-table">
      <thead>
        <tr>
          <th scope="col">Component</th>
          {% for year in include.years %}
          <th scope="col">CY{{ year }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for category in site.data.components.categories %}
          <!-- Category header row -->
          <tr class="category-header">
            <td colspan="{{ col_count }}">{{ category.name }}</td>
          </tr>

          {% for item in category.items %}
            <tr{% assign mod = forloop.index | modulo: 2 %}{% if mod == 0 %} class="row-alt"{% endif %}>
              <td class="font-semibold whitespace-nowrap">
                {{ item.name }}
                {% if item.min_max %}
                  <span class="text-xs text-gray-500 dark:text-gray-400" title="Minimum/Maximum version semantics apply">&#8595;&#8593;</span>
                {% endif %}
              </td>

              {% for year in include.years %}
                {% assign year_key = "CY" | append: year %}
                {% assign year_data = site.data.platforms[year_key] %}

                {% if category.id == "components" %}
                  {% assign item_data = year_data.components[item.id] %}
                {% else %}
                  {% assign section = year_data[category.id] %}
                  {% assign item_data = section[item.id] %}
                {% endif %}

                {% assign version_changed = false %}
                {% if item_data and item_data.version %}
                  {% assign prev_year_num = year | minus: 1 %}
                  {% assign prev_year_key = "CY" | append: prev_year_num %}
                  {% assign prev_year_data = site.data.platforms[prev_year_key] %}
                  {% if prev_year_data %}
                    {% if category.id == "components" %}
                      {% assign prev_item_data = prev_year_data.components[item.id] %}
                    {% else %}
                      {% assign prev_section = prev_year_data[category.id] %}
                      {% assign prev_item_data = prev_section[item.id] %}
                    {% endif %}
                    {% if prev_item_data and prev_item_data.version and item_data.version != prev_item_data.version %}
                      {% assign version_changed = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}

                <td class="text-sm{% if version_changed %} version-changed{% endif %}">
                  {% if item_data and item_data.version %}
                    <span class="font-mono">{{ item_data.version }}</span>
                    {% if item_data.inline_note %}
                      <br><small class="text-gray-500 dark:text-gray-400">({{ item_data.inline_note }})</small>
                    {% endif %}
                    {% if item_data.note %}
                      <br><small><a href="#{{ item_data.note }}" data-note-id="{{ item_data.note }}" class="text-blue-600 dark:text-blue-400 hover:underline">(see notes)</a></small>
                    {% endif %}
                  {% else %}
                    <span class="text-gray-400">&mdash;</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if include.show_history_link %}
{% assign oldest_year = include.years | last | minus: 1 %}
<div class="text-right mt-3">
  <a href="{{ '/platform_history.html' | relative_url }}#CY{{ oldest_year }}" class="text-sm text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center gap-1">
    View Earlier Platforms
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
    </svg>
  </a>
</div>
{% endif %}
